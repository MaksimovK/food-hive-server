model Address {
  id String @id @default(uuid())

  label     String?
  street    String
  house     String
  apartment String?
  entrance  String?
  floor     String?
  comment   String?
  isDefault Boolean @default(false) @map("is_default")

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("addresses")
}

model Banner {
  id String @id @default(uuid())

  image       String
  title       String?
  description String?
  link        String?
  order       Int     @default(0)
  isActive    Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("banners")
}

model CartItem {
  id String @id @default(uuid())

  quantity Int @default(1)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@map("cart_items")
}

model Category {
  id String @id @default(uuid())

  name        String  @unique
  image       String?
  description String?
  order       Int     @default(0)
  isActive    Boolean @default(true) @map("is_active")

  products Product[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("categories")
}

model Favorite {
  id String @id @default(uuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([userId, productId])
  @@map("favorites")
}

model Order {
  id String @id @default(uuid())

  userName      String        @map("user_name")
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING) @map("payment_status")
  totalAmount   Float         @map("total_amount")

  deliveryStreet    String  @map("delivery_street")
  deliveryHouse     String  @map("delivery_house")
  deliveryApartment String? @map("delivery_apartment")
  deliveryEntrance  String? @map("delivery_entrance")
  deliveryFloor     String? @map("delivery_floor")
  deliveryComment   String? @map("delivery_comment")
  deliveryPhone     String  @map("delivery_phone")
  orderComment      String? @map("order_comment")

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  orderItems OrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id String @id @default(uuid())

  quantity    Int
  price       Float
  productName String @map("product_name")

  orderId String @map("order_id")
  order   Order  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId String?  @map("product_id")
  product   Product? @relation(fields: [productId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@map("order_items")
}

/// Статусы заказа:
///   PENDING      — Ожидает подтверждения
///   CONFIRMED    — Подтверждён рестораном
///   PREPARING    — Готовится
///   ON_THE_WAY   — Курьер в пути
///   DELIVERED    — Доставлен
///   CANCELLED    — Отменён
enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  ON_THE_WAY
  DELIVERED
  CANCELLED
}

/// Статусы оплаты:
///   PENDING   — Ожидает оплаты
///   PAID      — Оплачен
///   REFUNDED  — Средства возвращены
enum PaymentStatus {
  PENDING
  PAID
  REFUNDED
}

model Product {
  id String @id @default(uuid())

  name        String
  description String?
  image       String
  price       Float

  caloriesPer100g Float   @map("calories_per_100g")
  proteinPer100g  Float   @map("protein_per_100g")
  fatPer100g      Float   @map("fat_per_100g")
  carbsPer100g    Float   @map("carbs_per_100g")
  servingSize     Int     @map("serving_size")
  isActive        Boolean @default(true) @map("is_active")

  productIngredients ProductIngredient[]

  categoryId String   @map("category_id")
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  favorites  Favorite[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([categoryId])
  @@map("products")
}

model Ingredient {
  id String @id @default(uuid())

  name String @unique

  containsGluten Boolean @default(false) @map("contains_gluten")
  containsDairy  Boolean @default(false) @map("contains_dairy")
  containsNuts   Boolean @default(false) @map("contains_nuts")
  containsSoy    Boolean @default(false) @map("contains_soy")
  containsEggs   Boolean @default(false) @map("contains_eggs")

  productIngredients ProductIngredient[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("ingredients")
}

model ProductIngredient {
  id String @id @default(uuid())

  amount Float?
  unit   String?

  productId String  @map("product_id")
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  ingredientId String     @map("ingredient_id")
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([productId, ingredientId])
  @@map("product_ingredients")
}

generator client {
  provider     = "prisma-client-js"
  output       = "../../src/database/prisma/generated"
  moduleFormat = "cjs"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  email    String   @unique
  password String
  name     String?
  phone    String?  @unique
  avatar   String?
  role     UserRole @default(USER)

  addresses     Address[]
  favorites     Favorite[]
  cartItems     CartItem[]
  orders        Order[]
  refreshTokens RefreshToken[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model RefreshToken {
  id String @id @default(uuid())

  tokenHash String   @unique @map("token_hash")
  deviceId  String   @map("device_id")
  expiresAt DateTime @map("expires_at")
  revoked   Boolean  @default(false)

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, deviceId])
  @@map("refresh_tokens")
}

enum UserRole {
  USER
  ADMIN
}
